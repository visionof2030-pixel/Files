# main.py
from fastapi import FastAPI, HTTPException, Depends, Header
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import HTMLResponse
from pydantic import BaseModel
from pathlib import Path
from datetime import datetime, timedelta
import os
import itertools
import google.generativeai as genai

from database import init_db, get_connection
from create_key import create_key
from security import activation_required

# ---------- Init DB ----------
init_db()

# ---------- App ----------
app = FastAPI()

app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# ---------- Admin Auth ----------
ADMIN_TOKEN = os.getenv("ADMIN_TOKEN", "")

def admin_auth(x_admin_token: str = Header(...)):
    if x_admin_token != ADMIN_TOKEN:
        raise HTTPException(status_code=401, detail="Unauthorized")

# ---------- Models ----------
class Req(BaseModel):
    prompt: str

class GenerateKeyReq(BaseModel):
    plan: str

# ---------- Plans ----------
PLANS = {
    "5min_1":   {"minutes": 5,    "usage": 1},
    "15min_2":  {"minutes": 15,   "usage": 2},
    "30min_3":  {"minutes": 30,   "usage": 3},
    "1day_6":   {"days": 1,       "usage": 6},
    "3day_15":  {"days": 3,       "usage": 15},
    "7day_25":  {"days": 7,       "usage": 25},
    "1m_45":    {"days": 30,      "usage": 45},
    "2m_65":    {"days": 60,      "usage": 65},
    "3m_120":   {"days": 90,      "usage": 120},
    "5m_200":   {"days": 150,     "usage": 200},
}

# ---------- Gemini Keys ----------
api_keys = [
    os.getenv("GEMINI_API_KEY_1"),
    os.getenv("GEMINI_API_KEY_2"),
    os.getenv("GEMINI_API_KEY_3"),
    os.getenv("GEMINI_API_KEY_4"),
    os.getenv("GEMINI_API_KEY_5"),
    os.getenv("GEMINI_API_KEY_6"),
    os.getenv("GEMINI_API_KEY_7"),
]
api_keys = [k for k in api_keys if k]
key_cycle = itertools.cycle(api_keys) if api_keys else None

def get_api_key():
    if not key_cycle:
        raise HTTPException(status_code=500, detail="No Gemini API key configured")
    return next(key_cycle)

# ---------- ุงูุจูุงูุงุช ุงููููููุฉ ูู ุงููุฑููุช ----------

# ุฅุฏุงุฑุงุช ุงูุชุนููู
EDUCATION_OFFICES = [
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ููุฉ ุงูููุฑูุฉ",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุงูุฑูุงุถ",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุงููุฏููุฉ ุงููููุฑุฉ",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจุงูููุทูุฉ ุงูุดุฑููุฉ",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุงููุตูู",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุนุณูุฑ",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุชุจูู",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุญุงุฆู",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุงูุญุฏูุฏ ุงูุดูุงููุฉ",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุฌุงุฒุงู",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ูุฌุฑุงู",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุงูุจุงุญุฉ",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจููุทูุฉ ุงูุฌูู",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจูุญุงูุธุฉ ุงูุฃุญุณุงุก",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจูุญุงูุธุฉ ุงูุทุงุฆู",
    "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ููุชุนููู ุจูุญุงูุธุฉ ุฌุฏุฉ"
]

# ุงูุฃุฏูุงุช ูุงููุณุงุฆู ุงูุชุนููููุฉ
EDUCATIONAL_TOOLS = [
    "ุณุจูุฑุฉ",
    "ุณุจูุฑุฉ ุฐููุฉ",
    "ุฌูุงุฒ ุนุฑุถ",
    "ุฃูุฑุงู ุนูู",
    "ุญุงุณุจ",
    "ุนุฑุถ ุชูุฏููู",
    "ุจุทุงูุงุช ุชุนููููุฉ",
    "ุตูุฑ ุชูุถูุญูุฉ",
    "ูุชุงุจ",
    "ุฃุฏูุงุช ุฑูุงุถูุฉ"
]

# ุงูุชูุงุฑูุฑ ุญุณุจ ุงูุชุตูููุงุช
REPORTS_BY_CATEGORY = {
    "ุงูุชูุงุฑูุฑ ุงูุชุนููููุฉ ุงูุตููุฉ": [
        "ุชูุฑูุฑ ุฃูุดุทุฉ ุตููุฉ",
        "ุชูุฑูุฑ ุชูุฒูุน ููุช ุงูุญุตุฉ",
        "ุชูุฑูุฑ ุฏุฑุณ ุชู ุชูููุฐู",
        "ุชูุฑูุฑ ุชุนููู ุชุนุงููู ุจูู ุงูุทูุงุจ",
        "ุชูุฑูุฑ ุงููุดุงุฑูุงุช ุจูู ุงูุทูุงุจ",
        "ุชูุฑูุฑ ุชูุฒูุน ุงููููุฌ",
        "ุชูุฑูุฑ ุงููุตูู ุงูููููุจุฉ",
        "ุชูุฑูุฑ ุชูููุฐ ุฏุฑุณ ุชุทุจููู",
        "ุชูุฑูุฑ ุชูุนูู ุงููุตูู ุงูุงูุชุฑุงุถูุฉ",
        "ุชูุฑูุฑ ุงูุชุนููู ุงููุฏูุฌ",
        "ุชูุฑูุฑ ุงูุชุนููู ุนู ุจุนุฏ",
        "ุชูุฑูุฑ ุงุณุชุฎุฏุงู ุฃูุธูุฉ ุฅุฏุงุฑุฉ ุงูุชุนูู",
        "ุชูุฑูุฑ ุฅุฏุงุฑุฉ ุงูููุช ูู ุงูุตู",
        "ุชูุฑูุฑ ุชูุธูู ุงูุจูุฆุฉ ุงูุตููุฉ",
        "ุชูุฑูุฑ ุฅุฏุงุฑุฉ ุงูููุงุฑุฏ ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุฅุฏุงุฑุฉ ุงูุณููู ุงูุตูู",
        "ุชูุฑูุฑ ุงูุฃูุดุทุฉ ุงูุชูุงุนููุฉ",
        "ุชูุฑูุฑ ุงูุนุฑูุถ ุงูุนูููุฉ",
        "ุชูุฑูุฑ ุงูุชุนูู ุงูุชุนุงููู",
        "ุชูุฑูุฑ ุงูุชุนูู ุงูุฐุงุชู ุงูููุฌู",
        "ุชูุฑูุฑ ุงูุฃูุนุงุจ ุงูุชุนููููุฉ ุงูุฑูููุฉ",
        "ุชูุฑูุฑ ุงูุชุนูู ุจุงูุฃูุฑุงู",
        "ุชูุฑูุฑ ุงุณุชุฑุงุชูุฌูุงุช ุงูุชุฏุฑูุณ ุงููุณุชุฎุฏูุฉ",
        "ุชูุฑูุฑ ุชูููุน ุฃุณุงููุจ ุงูุดุฑุญ",
        "ุชูุฑูุฑ ูุฑุงุนุงุฉ ุงููุฑูู ุงููุฑุฏูุฉ",
        "ุชูุฑูุฑ ุชูุนูู ููุงุฑุงุช ุงูุชูููุฑ",
        "ุชูุฑูุฑ ุฏูุฌ ููุงุฑุงุช ุงููุฑู ุงูุญุงุฏู ูุงูุนุดุฑูู",
        "ุชูุฑูุฑ ุชูุธูู ุงููุณุงุฆู ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุงูุชููุฆุฉ ุงูุฐูููุฉ ููุฏุฑุณ",
        "ุชูุฑูุฑ ุฎุชุงู ุงูุฏุฑุณ ูุงูุชูููู ุงูุฎุชุงูู",
        "ุชูุฑูุฑ ุฑุจุท ุงูุฏุฑุณ ุจุงูุญูุงุฉ"
    ],
    "ุงูุชูุงุฑูุฑ ุงูุนูุงุฌูุฉ ูุงูุฏุนู ุงููุฑุฏู": [
        "ุชูุฑูุฑ ุฎุทุฉ ุนูุงุฌูุฉ",
        "ุชูุฑูุฑ ุณุฌู ุงูุฎุทุท ุงูุนูุงุฌูุฉ",
        "ุชูุฑูุฑ ุฑุนุงูุฉ ุงูุทูุงุจ ุงููุชุฃุฎุฑูู ุฏุฑุงุณููุง",
        "ุชูุฑูุฑ ุฏุฑุงุณุฉ ุญุงูุฉ",
        "ุชูุฑูุฑ ูุนุฑูุฉ ุงููููู ูุงูุงุชุฌุงูุงุช",
        "ุชูุฑูุฑ ุงูุชุญููู ุงูุงุญุชูุงุฌุงุช ุงูุชุฏุฑูุจูุฉ",
        "ุชูุฑูุฑ ุฏุนู ุงูุทูุงุจ ุฐูู ุงูุฅุนุงูุฉ",
        "ุชูุฑูุฑ ุฎุทุฉ ุฏุนู ูุฑุฏูุฉ",
        "ุชูุฑูุฑ ูุชุงุจุนุฉ ุงูุชุญุณู ุงูุฃูุงุฏููู",
        "ุชูุฑูุฑ ุชุดุฎูุต ุตุนูุจุงุช ุงูุชุนูู",
        "ุชูุฑูุฑ ุจุฑุงูุฌ ุงูุชูููุฉ",
        "ุชูุฑูุฑ ุงูุฅุฑุดุงุฏ ุงูุฃูุงุฏููู ุงููุฑุฏู",
        "ุชูุฑูุฑ ูุชุงุจุนุฉ ุงูุฎุทุท ุงูุนูุงุฌูุฉ",
        "ุชูุฑูุฑ ุฏุนู ุงููููุจุฉ ููุฎูุถุฉ ุงูุชุญุตูู"
    ],
    "ุงูุชูุงุฑูุฑ ุงูุชุญููุฒูุฉ ูุงูุณููููุฉ": [
        "ุชูุฑูุฑ ุชุญููุฒ ุงูุทูุงุจ",
        "ุชูุฑูุฑ ุชุนุฒูุฒ ุงูุณููู ุงูุฅูุฌุงุจู",
        "ุชูุฑูุฑ ูุธุงู ุงูุญูุงูุฒ ูุงูููุงูุขุช",
        "ุชูุฑูุฑ ุจุฑูุงูุฌ ุงูุฏุนู ุงูููุณู",
        "ุชูุฑูุฑ ุชุญุณูู ูุชุงุฆุฌ ุงูุนููู ูู ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุฉ (ูุงูุณ)",
        "ุชูุฑูุฑ ุชุญุณูู ูุชุงุฆุฌ ุงูุฑูุงุถูุงุช ูู ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุฉ (ูุงูุณ)",
        "ุชูุฑูุฑ ุชุญุณูู ูุชุงุฆุฌ ุงููุบุฉ ุงูุนุฑุจูุฉ ูู ุงูุงุฎุชุจุงุฑุงุช ุงููุทููุฉ (ูุงูุณ)",
        "ุชูุฑูุฑ ุงูุงูุถุจุงุท ุงููุฏุฑุณู",
        "ุชูุฑูุฑ ูุนุงูุฌุฉ ุงูุณููููุงุช ุงูุณูุจูุฉ",
        "ุชูุฑูุฑ ุชุนุฒูุฒ ุงูุฏุงูุนูุฉ ููุชุนูู",
        "ุชูุฑูุฑ ุจูุงุก ุงูุงุชุฌุงูุงุช ุงูุฅูุฌุงุจูุฉ",
        "ุชูุฑูุฑ ูุชุงุจุนุฉ ุงูุณููู ุงููุฑุฏู",
        "ุชูุฑูุฑ ุจุฑุงูุฌ ุชุนุฏูู ุงูุณููู",
        "ุชูุฑูุฑ ุชุนุฒูุฒ ุงูููู ูุงูุงุชุฌุงูุงุช"
    ],
    "ุชูุงุฑูุฑ ุงูุฃูุดุทุฉ ุบูุฑ ุงูุตููุฉ": [
        "ุชูุฑูุฑ ูุดุงุท ุฅุซุฑุงุฆู",
        "ุชูุฑูุฑ ุฑุนุงูุฉ ุงูููููุจูู",
        "ุชูุฑูุฑ ุงููุจุงุฏุฑุงุช ูุงูุงุจุชูุงุฑ",
        "ุชูุฑูุฑ ุชูุนูู ุงูููุตุงุช ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุญุตุฉ ุงููุดุงุท",
        "ุชูุฑูุฑ ุชูุนูู ุญุตุต ุงููุดุงุท",
        "ุชูุฑูุฑ ุชูููุฐ ุฅุฐุงุนุฉ ูุฏุฑุณูุฉ",
        "ุชูุฑูุฑ ุงูุฒูุงุฑุงุช ุงูููุฏุงููุฉ",
        "ุชูุฑูุฑ ูุจุงุฏุฑุฉ ุชุทูุนูุฉ",
        "ุชูุฑูุฑ ุงูุงุญุชูุงู ุจุงูููู ุงููุทูู",
        "ุชูุฑูุฑ ุงููุนูู ุงูุตุบูุฑ",
        "ุชูุฑูุฑ ุงูุฃูุฏูุฉ ุงูุทูุงุจูุฉ",
        "ุชูุฑูุฑ ุงููุณุงุจูุงุช ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุงูุฃูุดุทุฉ ุงูุซูุงููุฉ",
        "ุชูุฑูุฑ ุงูุฃูุดุทุฉ ุงูุนูููุฉ",
        "ุชูุฑูุฑ ุงูุฃูุดุทุฉ ุงูุฑูุงุถูุฉ",
        "ุชูุฑูุฑ ุงูุฃูุดุทุฉ ุงููููุฉ",
        "ุชูุฑูุฑ ุงููุนุงุฑุถ ุงููุฏุฑุณูุฉ",
        "ุชูุฑูุฑ ุงูุฃูุงู ุงูุนุงูููุฉ",
        "ุชูุฑูุฑ ุงูุจุฑุงูุฌ ุงูููุณููุฉ"
    ],
    "ุชูุงุฑูุฑ ุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑ ูุงููุฌุชูุน": [
        "ุชูุฑูุฑ ุงูุชูุงุตู ูุน ููู ุงูุฃูุฑ",
        "ุชูุฑูุฑ ุฅุดุนุงุฑ ููู ุงูุฃูุฑ ุนู ูุณุชูู ุงุจูู",
        "ุชูุฑูุฑ ุณุฌู ุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑ",
        "ุชูุฑูุฑ ุญุถูุฑ ุงุฌุชูุงุน ุฃูููุงุก ุงูุฃููุฑ",
        "ุชูุฑูุฑ ุงูุดุฑุงูุงุช ุงูููููุฉ",
        "ุชูุฑูุฑ ูุฌุชูุนุงุช ุงูุชุนูู",
        "ุชูุฑูุฑ ุงููุฌุชูุนุงุช ุงูููููุฉ",
        "ุชูุฑูุฑ ุงูููุงุกุงุช ุงูุชุฑุจููุฉ",
        "ุชูุฑูุฑ ุงููุจุงุฏุฑุงุช ุงููุฌุชูุนูุฉ",
        "ุชูุฑูุฑ ุงูุชูุงุตู ุงูุฅููุชุฑููู ูุน ุฃูููุงุก ุงูุฃููุฑ",
        "ุชูุฑูุฑ ุงูุฒูุงุฑุงุช ุงูููุฒููุฉ",
        "ุชูุฑูุฑ ุงุณุชุทูุงุน ุฑุถุง ุฃูููุงุก ุงูุฃููุฑ",
        "ุชูุฑูุฑ ุงูุชุนุงูู ูุน ุงูุฌูุงุช ุงูุฎุงุฑุฌูุฉ",
        "ุชูุฑูุฑ ุงูุนูู ุงูุชุทูุนู ุงููุฌุชูุนู"
    ],
    "ุงูุชูุงุฑูุฑ ุงูุชุฎุทูุทูุฉ ูุงูุชูุธูููุฉ": [
        "ุชูุฑูุฑ ุฎุทุฉ ุฃุณุจูุนูุฉ",
        "ุชูุฑูุฑ ุชูุนูู ุงูุฎุทุฉ ุงูุฃุณุจูุนูุฉ",
        "ุชูุฑูุฑ ุชุฎุทูุท ุงููุดุงุฑูุน ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุชุฎุทูุท ุงูุฑุญูุงุช ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุฅุฏุงุฑุฉ ุงูุงุฌุชูุงุนุงุช",
        "ุชูุฑูุฑ ุงูููุงูุจุฉ ูุงููุณุญุฉ",
        "ุชูุฑูุฑ ุงูุฅุดุฑุงู ุงููููู",
        "ุชูุฑูุฑ ุฅุฏุงุฑุฉ ุงูุฃุฒูุงุช",
        "ุชูุฑูุฑ ุงูุฎุทุฉ ุงููุตููุฉ",
        "ุชูุฑูุฑ ุงูุฎุทุฉ ุงูุณูููุฉ",
        "ุชูุฑูุฑ ุชูุธูู ุงูุฌุฏุงูู ุงูุฏุฑุงุณูุฉ",
        "ุชูุฑูุฑ ุชูุธูู ุงูููุงู ุงูุฅุฏุงุฑูุฉ",
        "ุชูุฑูุฑ ุชูุฒูุน ุงูุฃุฏูุงุฑ",
        "ุชูุฑูุฑ ุฅุฏุงุฑุฉ ุงูููุช ุงููุฏุฑุณู",
        "ุชูุฑูุฑ ูุชุงุจุนุฉ ุชูููุฐ ุงูุฎุทุท"
    ],
    "ุชูุงุฑูุฑ ุงูุชูููู ูุงููุชุงุจุนุฉ": [
        "ุชูุฑูุฑ ูุดู ุงููุชุงุจุนุฉ",
        "ุชูุฑูุฑ ุชุตููู ุงูุทูุงุจ",
        "ุชูุฑูุฑ ุชูููุฐ ุงุฎุชุจุงุฑ ุชุญุณู",
        "ุชูุฑูุฑ ุณุฌู ุงูุฏุฑุฌุงุช ุงูุฅููุชุฑููู",
        "ุชูุฑูุฑ ุชุญููู ุงููุชุงุฆุฌ",
        "ุชูุฑูุฑ ููุงุฑูุฉ ุงูุณูุงุณู ุงูุฒูููุฉ",
        "ุชูุฑูุฑ ููุงุณ ุงูุฃุซุฑ ุงูุชุนูููู",
        "ุชูุฑูุฑ ูุคุดุฑุงุช ุงูุฃุฏุงุก ุงูุชุนูููู",
        "ุชูุฑูุฑ ุชูููู ุงููุฎุฑุฌุงุช ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุชูููู ุงููุดุงุฑูุน ุงูุทูุงุจูุฉ",
        "ุชูุฑูุฑ ุชูููู ุงูุฃุฏุงุก ุงูุนููู",
        "ุชูุฑูุฑ ุชูููู ุงููุญุงูุธ ุงูุฅููุชุฑูููุฉ",
        "ุชูุฑูุฑ ุงูุชูููู ุงูุฅููุชุฑููู",
        "ุชูุฑูุฑ ุชุญููู ูุชุงุฆุฌ ุงูุงุฎุชุจุงุฑุงุช ุงูุชุดุฎูุตูุฉ",
        "ุชูุฑูุฑ ุชุญููู ุงูุงุฎุชุจุงุฑุงุช ุงูุชุญุตูููุฉ",
        "ุชูุฑูุฑ ูุชุงุจุนุฉ ูุณุชูู ุงูุฅุชูุงู",
        "ุชูุฑูุฑ ูุฌูุงุช ุงูุชุนูู",
        "ุชูุฑูุฑ ุชูุฏู ุงูุทูุงุจ",
        "ุชูุฑูุฑ ุชุญููู ุจููุฏ ุงูุงุฎุชุจุงุฑ",
        "ุชูุฑูุฑ ูุชุงุจุนุฉ ููุงุชุฌ ุงูุชุนูู"
    ],
    "ุชูุงุฑูุฑ ุงูุชุฏุฑูุจ ูุงูุชุทููุฑ ุงููููู": [
        "ุชูุฑูุฑ ุญุถูุฑ ุฏูุฑุงุช ููุฑุด ุชุฏุฑูุจูุฉ",
        "ุชูุฑูุฑ ุงููุฑุด ุงูุชุฏุฑูุจูุฉ ุงูุชู ูุฏูุชูุง",
        "ุชูุฑูุฑ ุงูุชุฏุฑูุจ ุนูู ุงูุงุฎุชุจุงุฑุงุช ุงููุนูุงุฑูุฉ",
        "ุชูุฑูุฑ ุงูุชุฏุฑูุจ ุนูู ุงูููุงูุฌ ุงูุญุฏูุซุฉ",
        "ุชูุฑูุฑ ููู ุฃุซุฑ ุงูุชุฏุฑูุจ",
        "ุชูุฑูุฑ ูุชุงุจุนุฉ ุงูุฏูุฑุงุช ุงูุนุงูููุฉ",
        "ุชูุฑูุฑ ุงูุชุทููุฑ ุงููููู ุงููุณุชูุฑ",
        "ุชูุฑูุฑ ุงููุดุงุฑูุฉ ูู ุงููุคุชูุฑุงุช ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุญุถูุฑ ุงููุฏูุงุช ุงูุนูููุฉ",
        "ุชูุฑูุฑ ุงููุดุงุฑูุฉ ูู ุงูุจุญุซ ุงูุชุฑุจูู",
        "ุชูุฑูุฑ ุงูุชุนูู ุงูุฐุงุชู ุงููููู",
        "ุชูุฑูุฑ ูุฌุชูุนุงุช ุงูุชุนูู ุงูููููุฉ",
        "ุชูุฑูุฑ ุงููุฑุงุกุฉ ุงูุชุฑุจููุฉ ุงููุชุฎุตุตุฉ",
        "ุชูุฑูุฑ ุชุจุงุฏู ุงูุฎุจุฑุงุช",
        "ุชูุฑูุฑ ุจูุงุก ุงููุณุงุฑ ุงููููู"
    ],
    "ุชูุงุฑูุฑ ุชูุธูู ุงูุชูููููุฌูุง": [
        "ุชูุฑูุฑ ุงููุญุชูู ุงูุฑููู ุงูููุชุฌ",
        "ุชูุฑูุฑ ุฅูุชุงุฌ ุงููุญุชูู ุงูุฑููู",
        "ุชูุฑูุฑ ุงุณุชุฎุฏุงู ุฃูุธูุฉ ุฅุฏุงุฑุฉ ุงูุชุนูู",
        "ุชูุฑูุฑ ุงูุชูููู ุงูุฅููุชุฑููู",
        "ุชูุฑูุฑ ุงููุงูุน ุงููุนุฒุฒ ูู ุงูุชุนููู",
        "ุชูุฑูุฑ ุงูุฃูุนุงุจ ุงูุชุนููููุฉ ุงูุฑูููุฉ",
        "ุชูุฑูุฑ ุชูุธูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู",
        "ุชูุฑูุฑ ุงูุชุนูู ุงููุชููู",
        "ุชูุฑูุฑ ุงูุตููู ุงูุงูุชุฑุงุถูุฉ",
        "ุชูุฑูุฑ ุฃุฏูุงุช ุงูุชุนูู ุงูุชูุงุนูู",
        "ุชูุฑูุฑ ุงูุฃูู ุงูุฑููู",
        "ุชูุฑูุฑ ุงูุซูุงูุฉ ุงูุฑูููุฉ",
        "ุชูุฑูุฑ ุงูุชุญูู ุงูุฑููู",
        "ุชูุฑูุฑ ุงุณุชุฎุฏุงู ุงูุชุทุจููุงุช ุงูุชุนููููุฉ"
    ],
    "ุชูุงุฑูุฑ ุงูุจุญุซ ูุงูุชุทููุฑ ุงูููุงูุฌู": [
        "ุชูุฑูุฑ ุชุตููู ุงููุญุฏุงุช ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุฅุนุฏุงุฏ ุงูููุงุฏ ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุชุทููุฑ ุงูููุงูุฌ ุงูุฅุซุฑุงุฆูุฉ",
        "ุชูุฑูุฑ ุฅุนุฏุงุฏ ุจูู ุงูุฃุณุฆูุฉ",
        "ุชูุฑูุฑ ุชุตููู ุงูุฃูุดุทุฉ ุงููุงุตููุฉ",
        "ุชูุฑูุฑ ุชุญููู ูุญุชูู ุงููููุฌ",
        "ุชูุฑูุฑ ููุงุกูุฉ ุงููููุฌ ูุน ููุงุชุฌ ุงูุชุนูู",
        "ุชูุฑูุฑ ุชุญุฏูุซ ุงูุฎุทุท ุงูุฏุฑุงุณูุฉ",
        "ุชูุฑูุฑ ุชุทููุฑ ุฃุฏูุงุช ุงูุชูููู",
        "ุชูุฑูุฑ ุงูุจุญุซ ุงูุฅุฌุฑุงุฆู"
    ],
    "ุชูุงุฑูุฑ ุงูุฌูุฏุฉ ูุงููุฌุงู": [
        "ุชูุฑูุฑ ุนุถููุฉ ูุฌูุฉ ุงูุชููุฒ ูุงูุฌูุฏุฉ",
        "ุชูุฑูุฑ ุนุถููุฉ ูุฌูุฉ ุงูุชุฏููู",
        "ุชูุฑูุฑ ุฅุฏุงุฑุฉ ุงูููุงุฑุฏ ุงูุชุนููููุฉ",
        "ุชูุฑูุฑ ุชุญุณูู ุงูุฌูุฏุฉ",
        "ุชูุฑูุฑ ูุชุงุจุนุฉ ูุคุดุฑุงุช ุงูุฃุฏุงุก",
        "ุชูุฑูุฑ ุงูุชูููู ุงูุฐุงุชู",
        "ุชูุฑูุฑ ุงูุงุนุชูุงุฏ ุงููุฏุฑุณู",
        "ุชูุฑูุฑ ุงูุฎุทุท ุงูุชุญุณูููุฉ"
    ],
    "ุชูุงุฑูุฑ ุงูุฃูู ูุงูุณูุงูุฉ": [
        "ุชูุฑูุฑ ุฅุฌุฑุงุกุงุช ุงูุณูุงูุฉ ูู ุงูุตู",
        "ุชูุฑูุฑ ุงูุฑุนุงูุฉ ุงูุตุญูุฉ ูู ุงููุฏุฑุณุฉ",
        "ุชูุฑูุฑ ุฌุฑุฏ ุงููุฎุชุจุฑุงุช ูุบุฑู ุงููุตุงุฏุฑ",
        "ุชูุฑูุฑ ุฎุทุท ุงูุฅุฎูุงุก",
        "ุชูุฑูุฑ ุงูุณูุงูุฉ ุงููุฏุฑุณูุฉ",
        "ุชูุฑูุฑ ุฅุฏุงุฑุฉ ุงููุฎุงุทุฑ",
        "ุชูุฑูุฑ ุงูุฅุณุนุงูุงุช ุงูุฃูููุฉ",
        "ุชูุฑูุฑ ุฌุงูุฒูุฉ ุงููุจุงูู"
    ]
}

# ุชุตูููุงุช ุงูุชูุงุฑูุฑ
REPORT_CATEGORIES = [
    "ุงูุชูุงุฑูุฑ ุงูุชุนููููุฉ ุงูุตููุฉ",
    "ุงูุชูุงุฑูุฑ ุงูุนูุงุฌูุฉ ูุงูุฏุนู ุงููุฑุฏู",
    "ุงูุชูุงุฑูุฑ ุงูุชุญููุฒูุฉ ูุงูุณููููุฉ",
    "ุชูุงุฑูุฑ ุงูุฃูุดุทุฉ ุบูุฑ ุงูุตููุฉ",
    "ุชูุงุฑูุฑ ุงูุชูุงุตู ูุน ุฃูููุงุก ุงูุฃููุฑ ูุงููุฌุชูุน",
    "ุงูุชูุงุฑูุฑ ุงูุชุฎุทูุทูุฉ ูุงูุชูุธูููุฉ",
    "ุชูุงุฑูุฑ ุงูุชูููู ูุงููุชุงุจุนุฉ",
    "ุชูุงุฑูุฑ ุงูุชุฏุฑูุจ ูุงูุชุทููุฑ ุงููููู",
    "ุชูุงุฑูุฑ ุชูุธูู ุงูุชูููููุฌูุง",
    "ุชูุงุฑูุฑ ุงูุจุญุซ ูุงูุชุทููุฑ ุงูููุงูุฌู",
    "ุชูุงุฑูุฑ ุงูุฌูุฏุฉ ูุงููุฌุงู",
    "ุชูุงุฑูุฑ ุงูุฃูู ูุงูุณูุงูุฉ"
]

# ---------- PROMPT ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูููููู ูู ุงููุฑููุช ----------
AI_PROMPT_TEMPLATE = """ุฃูุช ุฎุจูุฑ ุชุฑุจูู ุชุนูููู ูุญุชุฑู ุชูุชูู ุฎุจุฑุฉ ููุฏุงููุฉ ูุงุณุนุฉ ูู ุงูุชุนููู ุงูุนุงู.  
ุงุนุชูุฏ ููุธูุฑูุง ุชุฑุจูููุง ูููููุง ุงุญุชุฑุงูููุง ูุฑููุฒ ุนูู ุชุญุณูู ุฌูุฏุฉ ุงูุชุนูููุ ูุฏุนู ุงููุนููุ ูุชุนุฒูุฒ ุจูุฆุฉ ุงูุชุนูููุ ูุฎุฏูุฉ ุงูููุงุฏุฉ ุงููุฏุฑุณูุฉ.  

ุงูุชูุฑูุฑ ุงููุทููุจ: "{report_type}"
{subject_line}
{lesson_line}
{grade_line}
{target_line}
{place_line}
{count_line}

**ุชูุฌููุงุช ููููุฉ:**
- ูู ููุถูุนููุง ููุชุฒููุง ูุจููุงุกู  
- ูุฏูู ุงูููุงุญุธุงุช ุจุตูุบุฉ ุชุทููุฑูุฉ ุบูุฑ ููุฏูุฉ  
- ุฑุงุนู ูุงูุน ุงูููุฏุงู ุงูุชุนูููู ูุณูุงู ุงููุฏุฑุณุฉ  
- ุงุฑุจุท ุจูู ุงููุนูู ูุงูุทุงูุจ ูุงููููุฌ ูุงูุจูุฆุฉ ุงูุตููุฉ ูุงูููุงุฏุฉ ุงููุฏุฑุณูุฉ  
- ุฑููุฒ ุนูู ุฌูุฏุฉ ุงูุชุนููู ูุฃุซุฑ ุงูููุงุฑุณุงุช ุนูู ุชุนูู ุงูุทูุงุจ  
- ุงูุชุฒู ุจูุบุฉ ุนุฑุจูุฉ ูุตูุญุฉ ุณูููุฉ ูุฎุงููุฉ ูู ุงูุฃุฎุทุงุก  

**ุดุฑูุท ุงููุญุชูู:**ุงูุชุจ ูุญุชูู ูู ุญูู ุจุตูุบุฉ ุชูุฑูุฑูุฉ ููููุฉ ููุฃูู ุตุงุฏุฑ ุนู ุงููุนูู.
ูุง ุชูุชุจ ุฃุจุฏุงู ุนููุงู ุงูุญูู ุฏุงุฎู ุงููุญุชูู ููุง ุชุนูุฏ ุตูุงุบุชู ุจุตูุบุฉ ูุจุงุดุฑุฉ (ูุซู: ุงููุฏู ุงูุชุฑุจูู ููุ ุงููุจุฐุฉ ุงููุฎุชุตุฑุฉ).
ูุฌุจ ุฃู ูุญุชูู ูู ุญูู ุนูู ูุง ููุงุฑุจ 25 ูููุฉ.
ุงุจุฏุฃ ุจุงููุถููู ูุจุงุดุฑุฉ ุฏูู ุชูููุฏ ุฃู ุนุจุงุฑุงุช ุฅูุดุงุฆูุฉ.
ูููู ุงูุงุณุชูุงุฏุฉ ูู ูุนูู ุงูุนููุงู ุฃู ุฃุญุฏ ููุงูููู ุจุดูู ุบูุฑ ูุจุงุดุฑ ููุท ุนูุฏ ุงูุญุงุฌุฉ ูุจูุง ูุฎุฏู ุงูููุฑุฉ ุฏูู ุชูุฑุงุฑ ุฃู ุญุดู.
ุงุญุฑุต ุนูู ูุฌูุฏ ุชุฑุงุจุท ููุทูู ุจูู ุงูุฃูุฏุงูุ ุงููุจุฐุฉ ุงููุฎุชุตุฑุฉุ ุงูุงุณุชุฑุงุชูุฌูุงุชุ ุฅุฌุฑุงุกุงุช ุงูุชูููุฐุ ููุงุท ุงูููุฉุ ููุงุท ุงูุชุญุณููุ ูุงูุชูุตูุงุช.
ุงุฑุจุท ุงููุญุชูู ุจุงููุงุฏุฉ ุงูุฏุฑุงุณูุฉ ูุนููุงู ุงูุฏุฑุณ ุฅู ููุฌุฏุ ููุฐูู ุจููุงู ุงูุชูููุฐุ ุจุฃุณููุจ ูููู ูุชูุงุฒู ูุฌูุน ุจูู ุงูุฅุดุงุฑุฉ ุงููุจุงุดุฑุฉ ูุบูุฑ ุงููุจุงุดุฑุฉ ุฏูู ุชููู.
ุงุฌุนู ุงููุฏู ุงูููุงุฆู ูููุญุชูู ุชุญุณูู ุงูููุงุฑุณุฉ ุงูุชุนููููุฉ ูุฏุนู ุงูุชุทููุฑ ุงููููู ุงููุณุชุฏุงู.
ุฑุงุนู ุงููุถูุญ ูุงูุชุฑุงุจุทุ ูุงุฌุนู ูู ุฌููุฉ ุชุถูู ูููุฉ ุชุนููููุฉ ูุนููุฉ.
ุงูุญููู ุงููุทููุจุฉ:**
1. ุงููุฏู ุงูุชุฑุจูู
2. ูุจุฐุฉ ูุฎุชุตุฑุฉ  
3. ุฅุฌุฑุงุกุงุช ุงูุชูููุฐ
4. ุงูุงุณุชุฑุงุชูุฌูุงุช
5. ููุงุท ุงูููุฉ
6. ููุงุท ุงูุชุญุณูู
7. ุงูุชูุตูุงุช

ูุฑุฌู ุชูุฏูู ุงูุฅุฌุงุจุฉ ุจุงููุบุฉ ุงูุนุฑุจูุฉ ุงููุตุญูุ ูุชูุธูููุง ุจุญูุซ ูููู ูู ุญูู ูู ุณุทุฑ ูููุตู ูุจุฏุฃ ุจุฑููู ููุท ุฏูู ุฐูุฑ ุงูุนููุงู."""

def build_ai_prompt(report_type: str, report_data: dict = None):
    """ุจูุงุก ุงูุจุฑููุช ุงูููุงุณุจ ููุฐูุงุก ุงูุงุตุทูุงุนู"""
    if not report_data:
        report_data = {}
    
    subject_line = f"ุงููุงุฏุฉ: {report_data.get('subject', '')}" if report_data.get('subject') else ""
    lesson_line = f"ุงูุฏุฑุณ: {report_data.get('lesson', '')}" if report_data.get('lesson') else ""
    grade_line = f"ุงูุตู: {report_data.get('grade', '')}" if report_data.get('grade') else ""
    target_line = f"ุงููุณุชูุฏููู: {report_data.get('target', '')}" if report_data.get('target') else ""
    place_line = f"ููุงู ุงูุชูููุฐ: {report_data.get('place', '')}" if report_data.get('place') else ""
    count_line = f"ุนุฏุฏ ุงูุญุถูุฑ: {report_data.get('count', '')}" if report_data.get('count') else ""
    
    return AI_PROMPT_TEMPLATE.format(
        report_type=report_type,
        subject_line=subject_line,
        lesson_line=lesson_line,
        grade_line=grade_line,
        target_line=target_line,
        place_line=place_line,
        count_line=count_line
    )

# ---------- Routes ----------
@app.get("/")
def root():
    return {"status": "running"}

@app.get("/health")
def health(_: int = Depends(activation_required)):
    return {"status": "ok"}

# ---------- ๐ฅ NEW: Subscription Status ----------
@app.get("/subscription/status")
def subscription_status(code_id: int = Depends(activation_required)):
    conn = get_connection()
    cur = conn.cursor()

    cur.execute("""
        SELECT
            expires_at,
            usage_limit,
            usage_count
        FROM activation_codes
        WHERE id = ?
    """, (code_id,))
    row = cur.fetchone()
    conn.close()

    if not row:
        raise HTTPException(status_code=404, detail="Subscription not found")

    expires_at, usage_limit, usage_count = row
    now = datetime.utcnow()

    expired = False
    if expires_at and datetime.fromisoformat(expires_at) < now:
        expired = True
    if usage_limit is not None and usage_count >= usage_limit:
        expired = True

    return {
        "expires_at": expires_at,
        "usage_limit": usage_limit,
        "usage_used": usage_count,
        "usage_remaining": (
            max(usage_limit - usage_count, 0)
            if usage_limit is not None else None
        ),
        "expired": expired
    }

# ---------- Main Feature (usage counted ONLY here) ----------
@app.post("/ask")
def ask(
    req: Req,
    code_id: int = Depends(activation_required)
):
    conn = get_connection()
    cur = conn.cursor()

    cur.execute("""
        UPDATE activation_codes
        SET usage_count = usage_count + 1,
            last_used_at = ?
        WHERE id = ?
    """, (datetime.utcnow().isoformat(), code_id))

    conn.commit()
    conn.close()

    genai.configure(api_key=get_api_key())
    model = genai.GenerativeModel("models/gemini-2.5-flash-lite")
    response = model.generate_content(req.prompt)

    return {"answer": response.text}

# ---------- API ูุฌูุจ ุงูุจูุงูุงุช ูููุฑููุช ----------
@app.get("/api/report-categories")
def get_report_categories():
    """ุฌูุจ ุฌููุน ุชุตูููุงุช ุงูุชูุงุฑูุฑ"""
    return {
        "categories": REPORT_CATEGORIES,
        "reports_by_category": REPORTS_BY_CATEGORY
    }

@app.get("/api/education-offices")
def get_education_offices():
    """ุฌูุจ ุฌููุน ุฅุฏุงุฑุงุช ุงูุชุนููู"""
    return EDUCATION_OFFICES

@app.get("/api/educational-tools")
def get_educational_tools():
    """ุฌูุจ ุฌููุน ุงูุฃุฏูุงุช ุงูุชุนููููุฉ"""
    return EDUCATIONAL_TOOLS

@app.get("/api/all-reports")
def get_all_reports():
    """ุฌูุจ ุฌููุน ุงูุชูุงุฑูุฑ ุจุดูู ูุณุทุญ ููุจุญุซ"""
    all_reports = []
    for category, reports in REPORTS_BY_CATEGORY.items():
        for report in reports:
            all_reports.append({
                "name": report,
                "category": category
            })
    return all_reports

@app.post("/api/generate-report-content")
def generate_report_content(
    req: dict,
    code_id: int = Depends(activation_required)
):
    """
    ุชูููุฏ ูุญุชูู ุงูุชูุฑูุฑ ุจุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    """
    report_type = req.get("report_type", "")
    report_data = req.get("report_data", {})
    
    if not report_type:
        raise HTTPException(status_code=400, detail="Report type is required")
    
    # ุจูุงุก ุงูุจุฑููุช ุงูููุงุณุจ
    prompt = build_ai_prompt(report_type, report_data)
    
    # ุชุญุฏูุซ ุนุฏุฏ ุงูุงุณุชุฎุฏุงูุงุช
    conn = get_connection()
    cur = conn.cursor()
    
    cur.execute("""
        UPDATE activation_codes
        SET usage_count = usage_count + 1,
            last_used_at = ?
        WHERE id = ?
    """, (datetime.utcnow().isoformat(), code_id))
    
    conn.commit()
    conn.close()
    
    # ุงุณุชุฎุฏุงู ุงูุฐูุงุก ุงูุงุตุทูุงุนู
    genai.configure(api_key=get_api_key())
    model = genai.GenerativeModel("models/gemini-2.5-flash-lite")
    response = model.generate_content(prompt)
    
    return {
        "content": response.text,
        "report_type": report_type,
        "generated_at": datetime.utcnow().isoformat()
    }

# ---------- Admin APIs ----------
@app.post("/admin/generate", dependencies=[Depends(admin_auth)])
def admin_generate(req: GenerateKeyReq):
    if req.plan not in PLANS:
        raise HTTPException(status_code=400, detail="Invalid plan")

    plan = PLANS[req.plan]
    now = datetime.utcnow()
    expires_at = now

    if "minutes" in plan:
        expires_at += timedelta(minutes=plan["minutes"])
    if "days" in plan:
        expires_at += timedelta(days=plan["days"])

    return {
        "code": create_key(
            expires_at.isoformat(),
            plan["usage"]
        ),
        "expires_at": expires_at.isoformat(),
        "usage_limit": plan["usage"]
    }

@app.get("/admin/codes", dependencies=[Depends(admin_auth)])
def admin_codes():
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("""
        SELECT
            id,
            code,
            is_active,
            expires_at,
            usage_limit,
            usage_count
        FROM activation_codes
    """)
    rows = cur.fetchall()
    conn.close()

    now = datetime.utcnow()
    result = []

    for r in rows:
        expired = False
        if r[3] and datetime.fromisoformat(r[3]) < now:
            expired = True
        if r[4] is not None and r[5] >= r[4]:
            expired = True

        result.append({
            "id": r[0],
            "code": r[1],
            "active": bool(r[2]),
            "expires_at": r[3],
            "usage_limit": r[4],
            "usage_count": r[5],
            "expired": expired
        })

    return result

@app.put("/admin/code/{code_id}/toggle", dependencies=[Depends(admin_auth)])
def admin_toggle(code_id: int):
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("""
        UPDATE activation_codes
        SET is_active = CASE WHEN is_active=1 THEN 0 ELSE 1 END
        WHERE id = ?
    """, (code_id,))
    conn.commit()
    conn.close()
    return {"status": "ok"}

@app.delete("/admin/code/{code_id}", dependencies=[Depends(admin_auth)])
def admin_delete(code_id: int):
    conn = get_connection()
    cur = conn.cursor()
    cur.execute("DELETE FROM activation_codes WHERE id=?", (code_id,))
    conn.commit()
    conn.close()
    return {"status": "deleted"}

# ---------- Admin Panel ----------
@app.get("/admin/panel", response_class=HTMLResponse)
def admin_panel():
    return Path("admin.html").read_text(encoding="utf-8")